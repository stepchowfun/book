image: ubuntu:18.04
default: build
tasks:
  install_packages:
    command: |
      set -euo pipefail
      export DEBIAN_FRONTEND=noninteractive
      apt-get update
      apt-get --yes install git python-pip texlive-full
      pip install awscli

  create_user:
    command: |
      set -euo pipefail
      adduser --disabled-password --gecos '' user

  build:
    dependencies:
      - create_user
      - install_packages
    input_paths:
      - .git
      - src
    output_paths:
      - book.pdf
    user: user
    command: |
      set -euo pipefail
      cd src
      echo -n 'This draft was generated from commit \commit{' > version.tex
      echo -n "$(git rev-parse --short HEAD)" >> version.tex
      echo -n '} on \today.' >> version.tex
      while
        pdflatex -halt-on-error -interaction=nonstopmode main.tex || exit 1
        bibtex main.aux || exit 1
        makeindex main || exit 1
        grep -qi 'Label(s) may have changed.' 'main.log' ||
          grep -qi 'Rerun to get outlines right' 'main.log' ||
          grep -qi 'There were undefined citations.' 'main.log' ||
          grep -qi 'Citation(s) may have changed.' 'main.log'
      do true; done
      mv main.pdf ../book.pdf

  publish:
    dependencies:
      - build
    environment:
      AWS_ACCESS_KEY_ID: null
      AWS_DEFAULT_REGION: null
      AWS_SECRET_ACCESS_KEY: null
    user: user
    command: |
      set -euo pipefail
      aws s3 cp --acl public-read book.pdf s3://static.stephanboyer.com/book.pdf
